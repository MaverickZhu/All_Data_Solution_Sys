# 多模态智能数据分析平台 - 环境部署总结

## 部署时间
- 2025年1月3日

## 环境配置概览

### 1. 基础环境（venv - Python 3.13.5）
✅ **状态：已部署**
- **核心框架**: FastAPI, Uvicorn, Pydantic
- **数据库连接**: SQLAlchemy, PyMongo, Motor, asyncpg
- **数据处理**: Pandas, NumPy, Scikit-learn
- **工具库**: Requests, HTTPX, PyYAML
- **后端服务**: 已成功启动在 http://localhost:8008

### 2. AI/ML环境（venv_ml - Python 3.12.0）
✅ **状态：已部署**
- **深度学习框架**: 
  - PyTorch 2.5.1+cu121（支持CUDA 12.1）
  - ✅ 已检测到RTX 4090 GPU
  - CUDA版本: 12.1
- **NLP框架**:
  - Transformers 4.53.0
  - LangChain 0.3.26
  - LlamaIndex 0.12.46 ✅（功能正常，仅版本号显示有问题）
  - Sentence-Transformers 5.0.0
- **多模态处理**:
  - OpenCV 4.11.0
  - Pillow 11.0.0
  - Librosa 0.11.0
  - MoviePy 2.1.2
- **向量数据库**:
  - PyMilvus 2.5.12
  - Neo4j 5.28.1
- **模型优化**:
  - ONNX Runtime 1.22.0

### 3. Docker服务
✅ **状态：运行中**
- MongoDB（端口27018）
- Redis（端口6379）
- PostgreSQL（端口5432）
- Milvus（端口19530）
- 其他服务（Nginx、Dify等）

## Docker服务配置

- **Prometheus配置**：修正了`prometheus.yml`文件中的配置问题，确保监控服务正常运行。
- **Neo4j容器**：调整了`docker-compose.dev.yml`中的端口配置，解决了容器冲突问题。
- **容器重启**：成功重启了Neo4j、Grafana、Prometheus、Kibana、RabbitMQ等容器，确保所有服务正常运行。

## 数据库服务状态

- **PostgreSQL**：正常运行，用于存储项目核心数据。
- **Redis**：正常运行，用于缓存和会话管理。
- **MongoDB**：正常运行，用于存储非结构化数据。
- **Neo4j**：正常运行，用于图数据分析和关系管理。

## API端口配置

- **前端服务**：运行在`http://localhost:3000`。
- **后端API**：运行在`http://localhost:8008`。

## 测试用户信息

- **测试用户**：`testuser` / `testpass123`，用于验证用户认证和项目管理功能。

## 其他配置

- **前端构建**：开发环境构建成功，可通过`http://localhost:3000`访问。生产环境构建需使用`npm run build`命令。

## 使用指南

### 启动基础后端服务
```powershell
# 激活基础环境
.\venv\Scripts\Activate.ps1

# 启动后端服务
cd backend
python main.py
```

### 使用AI/ML功能
```powershell
# 激活ML环境
# .\venv_ml\Scripts\Activate.ps1 # 根据实际情况选择
.\venv-py312\Scripts\Activate.ps1

# 运行AI/ML相关代码
python your_ml_script.py
```

### 访问服务
- API文档: http://localhost:8008/docs
- 健康检查: http://localhost:8008/health

### 关键API路径总结 (重要)
- **获取项目的数据源列表**:
  - `GET /api/v1/projects/{project_id}/datasources` (注意: `datasources`无下划线)
- **获取单个数据源详情**:
  - `GET /api/v1/projects/{project_id}/datasources/{ds_id}`
- **启动数据分析任务**:
  - `POST /api/v1/processing/profile/{data_source_id}`
  - **必需查询参数**: `?project_id={project_id}`

## 注意事项

1. **双环境架构**：
   - 基础服务使用 Python 3.12（venv）
   - AI/ML功能使用 Python 3.12（venv_ml）
   - 这样可以确保兼容性

2. **GPU加速**：
   - RTX 4090已正确识别
   - PyTorch已配置CUDA 12.1支持
   - 确保NVIDIA驱动程序是最新的

3. **数据库连接**：
   - Redis需要配置认证
   - 其他数据库服务都在Docker中运行

4. **模型下载**：
   - 首次使用某些模型时会自动下载
   - 建议配置代理以加速下载

5. **API 404 Not Found**:
  - **前端**: 检查`api.js`服务文件中的URL路径与后端路由是否完全匹配，特别注意**单复数** (`project` vs `projects`) 和**拼写** (`datasources` vs `data_sources`)。
  - **后端**: 确认FastAPI中`APIRouter`的`prefix`和函数的路由装饰器 (`@router.get(...)`) 组合成的最终路径是否正确。
- **API 422 Unprocessable Entity**:
  - 这通常意味着请求的路径是正确的，但请求体或**查询参数**不符合后端要求。
  - **后端**: 检查API端点函数定义，查看是否有必需的`Body(...)`或`Query(...)`参数。
  - **前端**: 确保API调用时传递了所有必需的参数。
- **前端导航问题 (点击不跳转或跳错页面)**:
  - **React Router**: 确保整个应用只有一个顶层的`<Router>`。检查`<Route path="...">`的定义是否与`<Link to="...">`或`navigate(...)`的目标路径匹配。
  - **状态管理/Context**: 检查`Context Provider`是否在`isLoading`等状态下意外地卸载了子组件（特别是包含路由的组件），并检查是否存在跨组件的变量名冲突导致的状态污染。

## 下一步建议

1. **创建.env文件**配置环境变量
2. **启动前端服务**（如果有）
3. **配置Neo4j等额外服务**（运行docker-compose）
4. **测试API接口**确保各功能正常

## 故障排查

- 如果遇到包版本冲突，使用对应的虚拟环境
- GPU相关问题检查CUDA驱动版本
- 数据库连接失败检查Docker服务状态

## 核心故障排查与最佳实践 (2025-07-08更新)

在近期一次解决 `celery-worker` 无限重启的故障中，我们总结出以下关键的环境配置与诊断最佳实践：

### 1. `.env` 文件配置原则
- **使用基础变量，而非计算变量**: Pydantic的 `Settings` 模型在初始化时，字段验证是无序的。因此，`.env` 文件中应只提供**基础**环境变量 (e.g., `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_HOST`, `POSTGRES_DB`)。完整的连接字符串 (e.g., `DATABASE_URL`) 应由 `config.py` 内的计算属性 (`@property`) 动态生成，绝不能依赖一个需要从其他字段计算而来的字段进行验证。
- **编码格式**: `.env` 文件必须使用 **UTF-8** 编码，否则可能导致Python的 `python-dotenv` 库解析失败，引发难以追踪的 `ValidationError`。
- **避免重复与冲突**: 确保 `.env` 文件中没有重复的键或存在冲突的配置。

### 2. Dockerfile 最佳实践
- **显式声明所有依赖**: `Dockerfile` 必须包含所有运行时依赖。对于Python项目，这不仅包括 `requirements.txt` 中的包，也包括代码逻辑中需要的**外部数据文件**。
  ```dockerfile
  # 示例：安装 NLTK 并下载其数据包
  RUN pip install nltk
  RUN python -m nltk.downloader punkt
  ```
- **保持镜像精简**: 避免在镜像中包含不必要的构建工具或缓存文件。

### 3. Docker Compose 诊断流程
- **`command` 指令是生命线**: 如果一个服务（特别是 `celery-worker`）启动后立即退出且日志为空，首先应检查 `docker-compose.yml` 中该服务的 `command` 是否被意外删除或注释。没有`command`，容器不知道要执行什么，就会立刻退出。
- **健康状态检查**: `docker-compose logs <service_name>` 可能会产生误导（如日志为空）。判断服务真实状态的黄金法则是 `docker-compose ps`。关注 `STATUS` 列，确认服务是 `Up` 还是 `Exited`。
- **环境变量注入**: 确保 `docker-compose.yml` 通过 `env_file` 或 `environment` 字段为服务注入了其启动所需的所有环境变量。

### 4. Windows PowerShell 注意事项
- **无 `&&` 操作符**: 在Windows PowerShell中，不能使用 `&&` 来连接两个命令。必须分两步执行。
  - **错误**: `docker-compose down && docker-compose up -d`
  - **正确**: 
    ```powershell
    docker-compose down
    docker-compose up -d
    ```

### 5. 架构配置核对
- **信任配置文件**: 在修改核心配置（如消息代理URL）时，**必须以 `docker-compose.yml` 等最终部署配置文件为准**，而不是凭个人经验或项目初期文档进行猜测。在本次故障中，项目实际使用 **RabbitMQ**，但被长期误认为是 Redis。

┌─────────────────────────────────────────────────────────┐
│                    前端应用层                             │
│         React + TypeScript + Ant Design Pro              │
├─────────────────────────────────────────────────────────┤
│                    API网关层                             │
│              Kong Gateway / Nginx                         │
├─────────────────────────────────────────────────────────┤
│                   微服务层                               │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌──────────┐  │
│  │数据接入  │  │语义处理  │  │分析建模  │  │可视化服务│  │
│  │服务      │  │服务      │  │服务      │  │         │  │
│  └─────────┘  └─────────┘  └─────────┘  └──────────┘  │
├─────────────────────────────────────────────────────────┤
│                    AI模型层                              │
│     LLM服务 | 向量嵌入 | 多模态处理 | GraphRAG          │
├─────────────────────────────────────────────────────────┤
│                   数据存储层                             │
│  PostgreSQL | MongoDB | Milvus | Redis | Neo4j          │
└─────────────────────────────────────────────────────────┘ 